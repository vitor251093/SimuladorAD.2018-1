<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">

<html>

<head>
    <title>Hello World Template</title>
    <script src="/static/js/Chart.bundle.js"></script>
</head>

<body>
    <div id="mask" style="position:absolute; opacity:0.7; width:100%; height:100%; background-color:#FFF; display:none;">
        <img style="position:absolute; left:calc(50% - 64px); top:calc(50% - 64px);" src="/static/images/spinner.gif"/>
    </div>
    
    <div style="width:75%;">
        <canvas id="canvas"></canvas>
    </div>
    <br>
    <br>
    <input type="checkbox" id="progressiveLoad"> Carregar progressivamente<br>
    <button id="runSimulator">Executar simulador</button>
    <script>
        window.chartColors = {
            red: 'rgb(255, 99, 132)',
            orange: 'rgb(255, 159, 64)',
            yellow: 'rgb(255, 205, 86)',
            green: 'rgb(75, 192, 192)',
            blue: 'rgb(54, 162, 235)',
            purple: 'rgb(153, 102, 255)',
            grey: 'rgb(201, 203, 207)'
        };

        var config = {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Simulação',
                    backgroundColor: window.chartColors.red,
                    borderColor: window.chartColors.red,
                    data: [],
                    fill: false,
                }]
            },
            options: {
                responsive: true,
                title: {display: false},
                tooltips: {enabled: false},
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        gridLines: {display:false},
                        scaleLabel: {
                            display: true,
                            labelString: 'Tempo'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        gridLines: {display:false},
                        scaleLabel: {
                            display: true,
                            labelString: 'Valor'
                        }
                    }]
                }
            }
        };

        window.onload = function () {
            var ctx = document.getElementById('canvas').getContext('2d');
            window.myLine = new Chart(ctx, config);
        };

        function setSpinnerVisible(visible) {
            var mask = document.getElementById("mask");
            mask.style["display"] = visible ? "block" : "none";
        }

        function loadFile(url, callback, errorCallback){
            var timeout = 24*60*60*1000; // 24 horas em milisegundos, garantindo que nunca haja timeout
            var xhr = new XMLHttpRequest();
            xhr.ontimeout = function () {
                console.error("The request for " + url + " timed out.");
            };
            xhr.onload = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    callback(xhr.responseText);
                }
                else {
                    if (errorCallback != undefined) errorCallback();
                }
            };
            xhr.open("GET", url, true);
            xhr.timeout = timeout;
            xhr.send(null);
        }

        
        document.getElementById('runSimulator').addEventListener('click', function () {
            var progressiveLoad = document.getElementById("progressiveLoad").checked;
            
            config.data.labels = [];
            config.data.datasets[0].data = [];
            window.myLine.update();
            

            if (progressiveLoad == false) {
                setSpinnerVisible(true);
            }

            var csvIndex = 0;
            var lastCheckedCsvIndex = -1;
            
            var loadNextCsvTime = 20;
            var reloadViewTime = 1000;

            var args = {progressivo: progressiveLoad.toString(),
                        rodadas: '1',
                        pacotesporrodada: '100'};
            var argsArray = [];
            var argKeys = Object.keys(args);
            for (var index = 0; index < argKeys.length; index++) {
                var key = argKeys[index];
                argsArray.push(key + "=" + args[key]);
            }
            var argsString = argsArray.join('&');

            loadFile('/simulator?' + argsString,function(simulatorText){
                if (progressiveLoad == false) {
                    setSpinnerVisible(false);

                    var simulatorComponents = simulatorText.split('\n');
                    for(var i = simulatorComponents.length - 1; i >= 0; i--) {
                        if (simulatorComponents[i].indexOf(',') == -1) {
                            simulatorComponents.splice(i, 1);
                        }
                    }
                    simulatorComponents = simulatorComponents.map(function(comp) {
                        var entry = comp.split(',');
                        return {value:parseFloat(entry[0]), group:parseInt(entry[1])};
                    });

                    simulatorValues = simulatorComponents.map(function(entry) {return entry.value;});
                    //simulatorColors = simulatorComponents.map(function(entry) {return entry.group;});
                    simulatorLabels = simulatorComponents.map(function(entry) {return "";});

                    config.data.labels = simulatorLabels;
                    config.data.datasets[0].data = simulatorValues;
                    window.myLine.update();
                }
            });

            if (progressiveLoad == true) {
                var continueProcedure = function() {
                    if (lastCheckedCsvIndex != csvIndex) 
                    {
                        lastCheckedCsvIndex = csvIndex;

                        loadFile('/plot/' + csvIndex + '.csv',function(simulatorText){
                            csvIndex += 1;

                            var simulatorComponents = simulatorText.split('\n');
                            for(var i = simulatorComponents.length - 1; i >= 0; i--) {
                                if (simulatorComponents[i].indexOf(',') == -1) {
                                    simulatorComponents.splice(i, 1);
                                }
                            }
                            simulatorComponents = simulatorComponents.map(function(comp) {
                                var entry = comp.split(',');
                                return {value:parseFloat(entry[0]), group:parseInt(entry[1])};
                            });

                            simulatorValues = simulatorComponents.map(function(entry) {return entry.value;});
                            //simulatorColors = simulatorComponents.map(function(entry) {return entry.group;});
                            simulatorLabels = simulatorComponents.map(function(entry) {return "";});

                            Array.prototype.push.apply(config.data.labels, simulatorLabels);
                            Array.prototype.push.apply(config.data.datasets[0].data, simulatorValues);
                            
                        },
                        function(){
                            lastCheckedCsvIndex = -1;
                        });
                    }
                    setTimeout(continueProcedure, loadNextCsvTime);
                }
                continueProcedure();

                var reloadViewProcedure = function() {
                    window.myLine.update();
                    setTimeout(reloadViewProcedure, reloadViewTime);
                };
                reloadViewProcedure();
            }
        });
    </script>
</body>

</html>